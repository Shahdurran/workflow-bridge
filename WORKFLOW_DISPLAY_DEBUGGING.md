# Workflow Display Debugging Guide

## Issue Reported

User saw "Unknown Action" in the visual workflow builder instead of proper node display. The workflow JSON was correctly generated by Claude, but the visual canvas wasn't rendering it properly.

## Debugging Steps Added

### 1. Added Console Logging

**File**: `automation-chatbot-frontend/src/hooks/useN8nChat.ts`

Added logging when workflow event is received:
```typescript
case 'workflow':
  console.log('ðŸ”¥ useN8nChat - Workflow event received:', data.workflow);
  console.log('ðŸ”¥ useN8nChat - Workflow nodes:', data.workflow?.nodes);
  // ... rest of code
```

**File**: `automation-chatbot-frontend/src/components/workflow/N8nWorkflowCanvas.tsx`

Added logging to see what data the canvas receives:
```typescript
export const N8nWorkflowCanvas = ({ workflow }: N8nWorkflowCanvasProps) => {
  console.log('N8nWorkflowCanvas - Workflow:', workflow);
  console.log('N8nWorkflowCanvas - Nodes:', nodes);
  console.log('N8nWorkflowCanvas - Connections:', connections);
  // ... rest of code
```

## How to Debug

### Step 1: Restart Frontend

The debugging code has been added. Restart the frontend to apply changes:

```powershell
# Stop the frontend terminal (Ctrl+C)
cd "d:\workflow bridge\automation-chatbot-frontend"
npm run dev
```

### Step 2: Open Browser Console

1. Navigate to `http://localhost:5173/n8n-chat`
2. Open browser DevTools (F12 or Right-click â†’ Inspect)
3. Go to the **Console** tab

### Step 3: Test the Workflow

Send a message:
```
"Create a Gmail to Sheets workflow"
```

### Step 4: Check Console Output

Look for these logs in order:

#### A. Workflow Event Received
```
ðŸ”¥ useN8nChat - Workflow event received: {name: "Gmail to Google Sheets", nodes: Array(2), ...}
ðŸ”¥ useN8nChat - Workflow nodes: Array(2)
```

**If you see this**: âœ… Backend is sending workflow correctly

**If you DON'T see this**: âŒ Backend isn't extracting workflow from Claude's response
- Check backend logs for "Extracted workflow with X nodes"
- Verify Claude is outputting JSON in ```json blocks

#### B. Workflow Added to Message
```
ðŸ”¥ useN8nChat - Adding workflow to message
```

**If you see this**: âœ… Workflow attached to chat message

**If you see "Could not find message to attach workflow"**: âŒ Timing issue
- The workflow event arrived before the message was created
- Or after the message ID changed

#### C. Canvas Receives Data
```
N8nWorkflowCanvas - Workflow: {name: "Gmail to Google Sheets", nodes: Array(2), ...}
N8nWorkflowCanvas - Nodes: Array(2)
  [0]: {parameters: {...}, name: "Gmail Trigger", type: "n8n-nodes-base.gmailTrigger", ...}
  [1]: {parameters: {...}, name: "Google Sheets", type: "n8n-nodes-base.googleSheets", ...}
N8nWorkflowCanvas - Connections: {Gmail Trigger: {...}}
```

**If you see this**: âœ… Canvas component is receiving the data

**If nodes array is empty**: âŒ Data structure issue
- Workflow object doesn't have `nodes` property
- Or nodes array is in wrong format

### Step 5: Identify the Issue

Based on console output, identify where the flow breaks:

| Console Output | Issue | Solution |
|----------------|-------|----------|
| No "Workflow event received" | Backend not sending workflow | Check backend logs, verify JSON extraction |
| "Workflow event received" but no "Adding workflow to message" | Message not found | Check message ID matching |
| "Adding workflow to message" but no canvas logs | Canvas not rendering | Check if WorkflowPreview component is mounted |
| Canvas logs show empty nodes | Data structure mismatch | Verify workflow.nodes exists and is array |
| Canvas logs show nodes but "Unknown Action" | Node type not recognized | Check node.type and node.name properties |

## Common Issues & Fixes

### Issue 1: Backend Not Extracting Workflow

**Symptom**: No "Workflow event received" log

**Check Backend Logs**:
```bash
# In backend terminal, look for:
"Extracted workflow with 2 nodes"
# OR
"Could not extract workflow"
# OR
"Failed to parse JSON from code block"
```

**Fix**:
- Verify Claude is outputting JSON in ```json code blocks
- Check if JSON is valid (use JSONLint.com)
- Ensure workflow has `nodes` property

### Issue 2: Timing Issue (Workflow Event Too Early)

**Symptom**: "Could not find message to attach workflow"

**Cause**: Workflow event arrives before assistant message is created

**Fix** (if needed):
```typescript
// In useN8nChat.ts, modify workflow case:
case 'workflow':
  console.log('Workflow event received');
  
  // Wait a bit for message to be created
  setTimeout(() => {
    setMessages(prev => {
      const lastMessage = prev[prev.length - 1];
      if (lastMessage?.role === 'assistant') {
        return [...prev.slice(0, -1), {...lastMessage, workflow: data.workflow}];
      }
      return prev;
    });
  }, 100);
  break;
```

### Issue 3: Node Names Don't Match

**Symptom**: Canvas logs show nodes, but displays "Unknown Action"

**Root Cause**: The `calculateNodePositions` function uses `node.name` as key, but connections might use different identifiers.

**Check**:
```javascript
// In console, expand the Nodes array and Connections object
// Verify that connection keys match node names exactly

// Example correct structure:
nodes: [
  {name: "Gmail Trigger", ...},
  {name: "Google Sheets", ...}
]
connections: {
  "Gmail Trigger": {  // <-- Must match node.name exactly
    "main": [[{node: "Google Sheets", ...}]]
  }
}
```

**Fix (if keys don't match)**:
```typescript
// In N8nWorkflowCanvas.tsx, modify position calculation to use node.id:
const positions = new Map<string, { x: number; y: number }>();
nodes.forEach((node, idx) => {
  const identifier = node.id || node.name; // Use ID if available
  positions.set(identifier, {...});
});
```

### Issue 4: Canvas Not Rendering

**Symptom**: Workflow logs appear but no visual display

**Check**:
1. Is WorkflowPreview component mounted?
   - Open React DevTools
   - Look for `WorkflowPreview` in component tree

2. Is workflow prop being passed?
   - In React DevTools, select `WorkflowPreview`
   - Check props â†’ workflow â†’ should have nodes array

3. Is N8nWorkflowCanvas being rendered?
   - Check if `nodes.length > 0` condition is true

**Fix**:
```typescript
// In WorkflowPreview.tsx, add debug:
console.log('WorkflowPreview - nodes length:', nodes.length);
console.log('WorkflowPreview - rendering canvas?', nodes.length > 0);
```

## Expected Flow

### 1. User Sends Message
```
User: "Create Gmail to Sheets workflow"
```

### 2. Claude Generates Workflow
```
Claude: "I've created a workflow...

```json
{
  "name": "Gmail to Sheets",
  "nodes": [...]
}
```
"
```

### 3. Backend Extracts & Sends
```python
# claude_service.py
workflow = _extract_workflow(accumulated_text)
# Logs: "Extracted workflow with 2 nodes"

yield {
  "type": "workflow",
  "content": workflow
}
```

### 4. Frontend Receives
```typescript
// useN8nChat.ts
case 'workflow':
  // Logs: "ðŸ”¥ Workflow event received"
  setMessages(prev => [...prev.slice(0, -1), {...lastMessage, workflow: data.workflow}]);
```

### 5. Canvas Renders
```typescript
// N8nWorkflowCanvas.tsx
// Logs: "N8nWorkflowCanvas - Nodes: Array(2)"
// Renders: Visual node cards with connections
```

## Testing Checklist

After adding debug logs and restarting frontend:

- [ ] Open browser console before sending message
- [ ] Send test message: "Create Gmail to Sheets workflow"
- [ ] Verify "ðŸ”¥ Workflow event received" appears
- [ ] Verify "ðŸ”¥ Adding workflow to message" appears
- [ ] Verify "N8nWorkflowCanvas - Nodes" shows array with items
- [ ] Check if nodes have `name` and `type` properties
- [ ] Check if connections keys match node names
- [ ] Verify visual canvas renders (not "Unknown Action")

## Next Steps

1. **Restart frontend** with debug code
2. **Test workflow creation** 
3. **Check console logs** to see where it fails
4. **Report findings**:
   - Which logs appear?
   - Which logs are missing?
   - What do the node objects look like?
   - What do the connections look like?

With this information, we can identify exactly where the issue is and fix it.

---

## Quick Test Script

Paste this in browser console after workflow appears:

```javascript
// Check if workflow data exists
const lastMessage = document.querySelector('[data-testid="message-content"]');
console.log('Message element:', lastMessage);

// Try to access React internal state (hacky but useful)
const reactKey = Object.keys(lastMessage || {}).find(key => key.startsWith('__reactFiber'));
if (reactKey) {
  console.log('React fiber found - checking props');
}

// Or just check localStorage/sessionStorage
console.log('Local storage:', localStorage);
```

---

**Status**: Debugging code added. Please restart frontend and check console logs!



